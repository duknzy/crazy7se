<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocabulary GP - 2026 Season</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');
        
        body {
            background-color: #0b0e14;
            color: #e2e8f0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .f1-font {
            font-family: 'Orbitron', sans-serif;
        }

        .race-card {
            background: linear-gradient(145deg, #1a1f2e, #111521);
            border-left: 4px solid #e10600;
        }

        .option-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .option-btn:hover {
            transform: translateX(10px);
            background-color: #e10600;
            color: white;
            border-color: #e10600;
        }

        .progress-bar {
            height: 4px;
            background-color: #333;
            width: 100%;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: #e10600;
            transition: width 0.3s ease;
        }

        .checkered-pattern {
            background-image: linear-gradient(45deg, #222 25%, transparent 25%), 
                              linear-gradient(-45deg, #222 25%, transparent 25%), 
                              linear-gradient(45deg, transparent 75%, #222 75%), 
                              linear-gradient(-45deg, transparent 75%, #222 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }

        .pass-card {
            background: linear-gradient(135deg, #ffd700, #ff8c00);
            color: #000;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="app" class="w-full max-w-2xl">
        <div id="champion-screen" class="hidden race-card p-10 rounded-lg shadow-2xl text-center border-4 border-yellow-500">
            <h1 class="f1-font text-5xl mb-6 font-bold text-yellow-500 tracking-widest">SEASON CHAMPION</h1>
            <div class="pass-card p-6 rounded-lg mb-8">
                <p class="f1-font text-sm uppercase font-bold mb-2">Access Granted</p>
                <h2 class="text-3xl font-black">SUPER LICENSE PASS</h2>
                <p id="pass-id" class="mt-4 font-mono text-xs opacity-75"></p>
                <button id="copy-existing-pass" class="mt-4 bg-black/20 hover:bg-black/40 text-black text-xs px-4 py-2 rounded-full font-bold transition-all">
                    Copy License ID
                </button>
            </div>
            <p class="mb-8 text-gray-300">素晴らしい!もっと極めよう!</p>
            <div class="flex flex-col gap-4">
                <button onclick="quiz.returnToGrid()" class="f1-font bg-white text-black px-12 py-4 rounded-full font-bold tracking-tighter uppercase transition-transform active:scale-95">
                    Select Round
                </button>
                <button onclick="quiz.revokePass()" class="text-gray-500 text-xs hover:underline">Revoke License (Reset)</button>
            </div>
        </div>

        <div id="start-screen" class="race-card p-8 rounded-lg shadow-2xl text-center">
            <h1 class="f1-font text-4xl mb-2 font-bold text-white tracking-widest">VOCABULARY GP</h1>
            <p class="f1-font text-red-500 font-bold mb-6">2026 SEASON</p>
            
            <div class="bg-black/30 p-4 rounded mb-6 text-left border border-gray-700">
                <label class="text-gray-400 text-xs uppercase tracking-widest block mb-2">Select Circuit (Round)</label>
                <select id="round-selector" class="w-full bg-gray-800 text-white p-3 rounded border border-gray-600 focus:border-red-500 outline-none font-mono">
                    </select>
            </div>

            <div class="bg-red-900/30 border border-red-500 p-3 rounded mb-8">
                <p class="text-red-500 font-bold text-sm">LICENSE CRITERIA: Accuracy 90%+</p>
                <p class="text-xs text-gray-400">Total Words: <span id="total-words-count">0</span> | Rounds: 30</p>
            </div>

            <button onclick="quiz.start()" class="f1-font bg-red-600 hover:bg-red-700 text-white px-12 py-4 rounded-full font-bold tracking-tighter uppercase transition-transform active:scale-95 shadow-lg shadow-red-900/50">
                Start Engine
            </button>
        </div>

        <div id="quiz-screen" class="hidden race-card p-6 rounded-lg shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <div class="flex flex-col text-left">
                    <span id="circuit-name" class="f1-font text-xs text-gray-500 uppercase tracking-widest">ROUND 1</span>
                    <span id="question-number" class="f1-font text-red-500 font-bold text-xl">LAP 1 / 20</span>
                </div>
                <span id="timer" class="f1-font text-2xl text-yellow-400 font-mono">0.00s</span>
            </div>
            <div class="progress-bar mb-8">
                <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
            </div>

            <div class="mb-10 text-center relative">
                <p class="text-gray-400 text-sm uppercase tracking-widest mb-2">Meaning of:</p>
                <h2 id="target-word" class="f1-font text-5xl md:text-6xl font-black text-white mb-4 tracking-tight drop-shadow-lg">word</h2>
            </div>

            <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            <div id="feedback" class="mt-4 text-center h-6 font-bold"></div>
        </div>

        <div id="result-screen" class="hidden race-card p-8 rounded-lg shadow-2xl text-center">
            <h2 class="f1-font text-3xl mb-4 font-bold text-white">RACE FINISHED</h2>
            <div class="checkered-pattern h-8 w-full mb-6 rounded opacity-50"></div>
            
            <div id="accuracy-display" class="f1-font text-6xl font-bold mb-2">95.0%</div>
            <p id="rank-text" class="f1-font text-sm mb-6 text-gray-300">P1: WORLD CHAMPION</p>

            <div id="pass-issue-area" class="hidden mb-8 p-6 rounded-lg pass-card animate-bounce">
                <h3 class="font-black text-2xl mb-1">PASS GRANTED!</h3>
                <p class="text-sm mb-3">SUPER LICENSE ISSUED</p>
                <button id="copy-pass-btn" class="bg-black text-white text-xs px-6 py-2 rounded-full font-bold hover:scale-105 transition-transform">
                    COPY LICENSE ID
                </button>
            </div>

            <div id="fail-message" class="hidden mb-8 p-4 border border-red-500 bg-red-900/20 text-red-500 font-bold">
                LICENSE DENIED: Accuracy below 90%
            </div>

            <div class="bg-black/30 p-4 rounded mb-8 text-left max-h-48 overflow-y-auto border border-gray-800" id="review-list"></div>

            <div class="flex gap-4 justify-center">
                <button onclick="quiz.returnToGrid()" class="f1-font border-2 border-white hover:bg-white hover:text-black text-white px-8 py-3 rounded-full font-bold transition-all">
                    Back to Garage
                </button>
            </div>
        </div>
    </div>

    <script>
// RAW DATA INJECTION
// データ内のノイズ（など）はJS初期化時に自動除去される
const rawData = `
proceed: 続行する
ensure: 確実にする
interpret: 解釈する
cease: やめる
ban: 禁止する
obey: 従う
eliminate: 除去する
resist: 抵抗する
accompany: 同行する
commit: 犯す、委ねる
pursue: 追及する
demonstrate: 証明する
bet: 賭ける
ruin: 台無しにする
threaten: 脅す
attach: 取り付ける
reverse: 逆転させる
restrict: 制限する
compose: 構成する
lean: 傾く
substitute: 代わりにする
trace: 跡をたどる
interrupt: 邪魔する
confront: 直面する
illustrate: 説明する
arrest: 逮捕する
stimulate: 刺激する
assure: 保証する
consult: 相談する
depress: 意気消沈させる
crash: 衝突する
inspire: 奮起させる
specialize: 専門にする
cultivate: 耕す、育む
fulfill: 果たす
transmit: 送る、伝える
found: 設立する
clap: 拍手する
burst: 破裂する
bow: お辞儀する
dismiss: 解雇する、退ける
breed: 繁殖させる
prohibit: 禁止する
oblige: 強いる
qualify: 資格を与える
invest: 投資する
grasp: 掴む
collapse: 崩壊する
overlook: 見落とす
accuse: 非難する
frustrate: イライラさせる
deprive: 奪う
astonish: 驚嘆させる
register: 登録する
correspond: 一致する、連絡を取り合う
cast: 投げる
attribute: 帰せしめる
neglect: 怠る
starve: 飢える
resolve: 解決する
impose: 課す
convert: 変える
scare: 怖がらせる
constitute: 構成する
appoint: 指名する
imply: 暗示する
assign: 割り当てる
nod: 頷く
elect: 選挙する
transfer: 移す
rob: 奪う
capture: 捕らえる
undertake: 引き受ける
drown: 溺れ死ぬ
split: 割る
resort: 訴える
descend: 降りる
irritate: イライラさせる
pronounce: 発音する
equip: 装備させる
cheat: 騙す
emerge: 現れる
devote: 捧げる
heal: 治す
urge: 促す
envy: 羨む
chase: 追いかける
prompt: 促す
withdraw: 撤退させる
detect: 見つけ出す
interfere: 邪魔する
kid: 冗談を言う
laugh: 笑う
endanger: 危険にさらす
foster: 育む
diminish: 減少する
spill: こぼす
infect: 感染させる
tap: 軽く叩く
embrace: 抱きしめる
proportion: 割合
contract: 契約
chest: 胸
treasure: 宝物
stock: 在庫
facility: 施設
sum: 合計
rank: 階級
democracy: 民主主義
emergency: 緊急事態
protest: 抗議
immigrant: 移民
vehicle: 乗り物
routine: 決まりきった仕事
stuff: 持ち物
row: 列
profile: 横顔
dawn: 夜明け
welfare: 福祉
perspective: 視点
enthusiasm: 熱狂
faith: 信頼
occupation: 職業
witness: 目撃者
kingdom: 王国
equivalent: 同等のもの
objective: 目標
pile: 積み重ね
shelter: 避難所
trial: 試み
honor: 名誉
territory: 領土
frame: 枠組み
border: 境界
statistics: 統計
enterprise: 企業
context: 文脈
load: 荷物
grain: 穀物
review: 再検討
prejudice: 偏見
strain: 負担
trap: 罠
temper: 気分
slave: 奴隷
wound: 傷
divorce: 離婚
tune: 曲
height: 高さ
faculty: 能力
span: 期間
dimension: 寸法
version: 版
parallel: 平行な
horizon: 地平線
acquaintance: 知人
burden: 重荷
basis: 基礎
poison: 毒
constitution: 憲法
administration: 管理
charm: 魅力
organ: 臓器
prey: 獲物
venture: 冒険的事業
mission: 任務
inquiry: 問い合わせ
award: 賞
strip: 細長い破片
distress: 苦しみ
circulation: 循環
shade: 陰
stereotype: 固定観念
client: 顧客
output: 出力
lord: 貴族
convention: 慣習
mine: 地雷
craft: 工芸
core: 核心
stroke: 打撃、脳卒中
frontier: 国境
peer: 仲間
vessel: 容器、船
disability: 障害
gravity: 重力
ethic: 倫理
terminal: 終着駅
tide: 潮
abuse: 虐待
guilty: 有罪の
vital: 極めて重要な
fellow: 仲間
contemporary: 現代の
annual: 年に一度の
accustomed: 慣れている
steady: 着実な
dull: 退屈な
keen: 鋭い
loose: ゆるい
delicate: 繊細な
internal: 内部の
casual: 何気ない
mature: 成熟した
concrete: 具体的な
awful: ひどい
exhausted: 疲れ果てた
overall: 全体的な
tight: きつい
prime: 最も重要な
genuine: 本物の
modest: 謙虚な
intimate: 親密な
minimum: 最小限の
sophisticated: 洗練された
latter: 後者の
bitter: 苦い
peculiar: 独特の
passive: 受動的な
ethnic: 民族の
noble: 高貴な
vain: 無駄な
innocent: 無実の
underlying: 根本的な
alien: 異質な
relevant: 関連のある
inclined: したいと思う
awkward: 不器用な、気まずい
brilliant: 素晴らしい
desperate: 必死の
refreshing: さわやかな
thrilled: わくわくした
inner: 内側の
consistent: 一貫した
plain: 明白な、簡素な
vivid: 鮮やかな
miserable: 惨めな
substantial: かなりの
fond: 好んで
false: 誤った
lazy: 怠惰な
precisely: 正確に
meanwhile: その間に
altogether: 完全に
lately: 最近
barely: かろうじて
scarcely: ほとんど～ない
accordingly: それに応じて
beneath: ～の下に
whereas: ～である一方で
declare: 宣言する
alter: 変える
arise: 生じる
transform: 変える
defeat: 打ち負かす
investigate: 調査する
distinguish: 区別する
bury: 埋める
cope: 対処する
occur: 起こる
accomplish: 成し遂げる
hesitate: 躊躇する
endure: 耐える
conclude: 結論づける
guarantee: 保証する
dominate: 支配する
confirm: 確認する
greet: 挨拶する
entertain: 楽しませる
defend: 防御する
forbid: 禁止する
broadcast: 放送する
sacrifice: 犠牲にする
punish: 罰する
glance: ちらりと見る
retain: 保持する
calculate: 計算する
sinking: 沈没
rescue: 救助する
beg: 乞う
define: 定義する
deceive: 騙す
convey: 伝える
sustain: 維持する
purchase: 購入する
fade: 消えていく
regulate: 規制する
distribute: 分配する
enhance: 高める
chat: おしゃべりする
exceed: 超える
wipe: 拭く
cooperate: 協力する
inherit: 相続する
unite: 団結させる
leap: 跳ぶ
exaggerate: 誇張する
conquer: 征服する
melt: 溶ける
invade: 侵入する
modify: 修正する
scatter: まき散らす
undergo: 経験する
evaluate: 評価する
bend: 曲げる
derive: 引き出す
screaming: 叫び
gaze: 見つめる
pray: 祈る
polish: 磨く
classify: 分類する
assert: 断言する
grab: 掴む
fold: 畳む
sweep: 掃除する
whisper: 囁く
imitate: 模倣する
stare: 凝視する
emphasize: 強調する
get rid of: 処分する
pour: 注ぐ
vanish: 消える
restore: 修復する
deserve: 値する
laboratory: 研究所
conference: 会議
continent: 大陸
insurance: 保険
crew: 乗組員
poverty: 貧困
shortage: 不足
affair: 事件
exception: 例外
low wage: 低賃金
wisdom: 知恵
tax: 税金
evolution: 進化
barrier: 障壁
category: 範疇
unit: 単位
reputation: 評判
virtue: 美徳
courage: 勇気
sympathy: 同情
union: 組合
civilization: 文明
volume: 音量
blossom: 花
era: 時代
settle dispute: 紛争を解決する
tourism: 観光
mankind: 人類
murder: 殺人
landscape: 風景
destination: 目的地
fairy tale: 童話
reform: 改革
muscle: 筋肉
prospect: 見通し
corporation: 法人
colony: 植民地
quarrel: 口論
profession: 職業
aspect: 側面
pause: 休止
conflict: 紛争
privilege: 特権
prosperity: 繁栄
genius: 天才
seed: 種
symptom: 症状
merit: 長所
layer: 層
clue: 手がかり
circumstances: 状況
district: 地区
prison: 刑務所
companion: 仲間
executive: 役員
justice: 正義
procedure: 手続き
ray: 光線
heaven: 天国
luxury: 贅沢
oxygen: 酸素
fund: 資金
theme: 主題
boundary: 境界
ambition: 野望
weather: 天候
psychology: 心理学
labor: 労働
committee: 委員会
physician: 医師
philosophy: 哲学
affection: 愛情
candidate: 候補者
bomb: 爆弾
priority: 優先事項
obstacle: 障害
appetite: 食欲
tension: 緊張
tribe: 部族
budget: 予算
campaign: キャンペーン
sorrow: 悲しみ
satellite: 衛星
insight: 洞察
cough: 咳
fate: 運命
scheme: 計画
insult: 侮辱
inhabitant: 居住者
fossil: 化石
motive: 動機
instinct: 本能
legend: 伝説
empire: 帝国
suburb: 郊外
architecture: 建築
passion: 情熱
cancer: 癌
logic: 論理
dozen: ダース
harvest: 収穫
ingredient: 材料
hypothesis: 仮説
voyage: 航海
editor: 編集者
option: 選択肢
hemisphere: 半球
mechanism: 仕組み
anthropologist: 人類学者
tragedy: 悲劇
antibiotic: 抗生物質
fare: 運賃
debt: 借金
curriculum: 教育課程
component: 構成要素
wheat: 小麦
usage: 語法
castle: 城
famine: 飢饉
extinction: 絶滅
purse: 小銭入れ
folk: 人々
explosion: 爆発
portion: 部分
organism: 有機体
merchant: 商人
myth: 神話
incident: 出来事
wildlife: 野生生物
congress: 国会
bay: 湾
penalty: 刑罰
heritage: 遺産
diversity: 多様性
thumb: 親指
geography: 地理学
factor: 要因
discrimination: 差別
virus: ウイルス
statue: 像
priest: 聖職者
pioneer: 先駆者
trait: 特徴
bond: 絆
grocery: 食料雑貨
secretary: 秘書
dialect: 方言
astronomy: 天文学
youngster: 若者
substance: 物質
finding: 発見
strategy: 戦略
lung: 肺
opponent: 相手
ritual: 儀式
outcome: 結果
conservation: 保存
mammal: 哺乳類
telescope: 望遠鏡
refugee: 難民
code: 規約
flavor: 風味
particle: 粒子
nursing: 看護
suicide: 自殺
habitat: 生息地
bullying: いじめ
dinosaur: 恐竜
council: 会議
gender: 性別
surgery: 手術
innovation: 革新
protein: タンパク質
nutrition: 栄養
disaster: 災害
emission: 排出
ape: 類人猿
molecule: 分子
sweat: 汗
transplant: 移植
species: 種
tip: 助言
cattle: 牛
density: 密度
concept: 概念
pale: 青白い
precious: 貴重な
loyal: 忠実な
isolated: 孤立した
generous: 寛大な
tropical: 熱帯の
reluctant: 気が進まない
vague: 曖昧な
vast: 広大な
numerous: 数多くの
rural: 田舎の
widespread: 広範囲にわたる
visible: 目に見える
raw: 生の
remote: 遠い
urgent: 緊急の
silly: 愚かな
striking: 著しい
adequate: 適切な
extraordinary: 並外れた
odd: 奇妙な
abstract: 抽象的な
mutual: 相互の
excessive: 過度の
ashamed: 恥じて
tremendous: 凄まじい
inevitable: 避けられない
pure: 純粋な
stable: 安定した
indifferent: 無関心な
aggressive: 攻撃的な
ultimate: 究極の
shy: 内気な
solar: 太陽の
profound: 深い
subtle: 微妙な
conservative: 保守的な
brave: 勇敢な
intense: 激しい
alcoholic: アルコールの
manual: 手動の
cruel: 残酷な
rational: 理性的な
initial: 初期の
immune: 免疫のある
linguistic: 言語の
crucial: 重要な
verbal: 言葉による
optimistic: 楽観的な
flexible: 柔軟な
grateful: 感謝している
lively: 元気な
overwhelming: 圧倒的な
abundant: 豊富な
selfish: 利己的な
ugly: 醜い
racial: 人種の
prominent: 卓越した
controversial: 論争を呼ぶ
federal: 連邦の
ridiculous: ばかげた
imaginary: 想像上の
harsh: 厳しい
random: 無作為な
adolescent: 思春期の
up-to-date: 最新の
liberal: 自由主義の
prior: 前の
moderate: 適度な
fluent: 流暢な
elaborate: 精巧な
incredible: 信じられない
radical: 急進的な
acid: 酸性の
deaf: 耳が聞こえない
medieval: 中世の
ecological: 生態学的な
slight: わずかな
ignorant: 無知な
cognitive: 認知の
absolutely: 絶対に
virtually: 事実上
somewhat: いくぶん
merely: 単に
literally: 文字通り
seemingly: 見たところ
regardless: かかわらず
thoroughly: 徹底的に
`;

        class VocabularyQuiz {
            constructor() {
                this.wordsPerRound = 20;
                this.masterList = [];
                this.rounds = [];
                this.currentRoundIndex = 0;
                
                this.questions = [];
                this.currentIndex = 0;
                this.missCount = 0;
                this.missedWordsLog = [];
                this.startTime = 0;
                this.timerInterval = null;

                // エンジンの初期化
                this.parseData();
                this.generateRounds();
                this.initUI();
            }

            // データ解析とクリーニング
            parseData() {
                // 生データを改行で分割し、sourceタグなどを除去
                const lines = rawData.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0 && !line.startsWith('[source'));

                this.masterList = [];

                lines.forEach(line => {
                    // "word: meaning" や "word meaning" などの形式に対応
                    // コロン、または最初の空白で分割
                    let separatorIndex = line.indexOf(':');
                    if (separatorIndex === -1) separatorIndex = line.indexOf(' ');
                    if (separatorIndex === -1) separatorIndex = line.indexOf('　'); // 全角スペース

                    if (separatorIndex !== -1) {
                        const w = line.substring(0, separatorIndex).trim();
                        const m = line.substring(separatorIndex + 1).trim();
                        if (w && m) {
                            this.masterList.push({ w, m });
                        }
                    }
                });

                document.getElementById('total-words-count').innerText = this.masterList.length;
            }

            // ラウンド（サーキット）生成
            generateRounds() {
                // 全単語をシャッフルせずに、順番通りにセットを作るか、シャッフルするか。
                // テキストファイルの並び順を維持して分割する場合はここを調整する。
                // 今回は「リスト順」で分割する（学習進度のため）
                const wordCopy = [...this.masterList]; 
                
                this.rounds = [];
                let roundNum = 1;

                while (wordCopy.length > 0) {
                    const chunk = wordCopy.splice(0, this.wordsPerRound);
                    if (chunk.length > 0) {
                        this.rounds.push({
                            id: roundNum,
                            name: `ROUND ${roundNum}`,
                            words: chunk
                        });
                        roundNum++;
                    }
                }
            }

            initUI() {
                // セレクトボックスの生成
                const selector = document.getElementById('round-selector');
                selector.innerHTML = '';
                this.rounds.forEach((round, index) => {
                    const opt = document.createElement('option');
                    opt.value = index;
                    opt.text = `${round.name} (${round.words.length} words)`;
                    selector.appendChild(opt);
                });

                // PASS確認
                const savedPass = localStorage.getItem('PASS');
                if (savedPass) {
                    document.getElementById('start-screen').classList.add('hidden');
                    document.getElementById('champion-screen').classList.remove('hidden');
                    document.getElementById('pass-id').innerText = `LICENSE_ID: ${savedPass}`;
                    
                    document.getElementById('copy-existing-pass').onclick = () => {
                        this.copyToClipboard(savedPass, document.getElementById('copy-existing-pass'));
                    };
                }
            }

            copyToClipboard(text, btnElement) {
                navigator.clipboard.writeText(text).then(() => {
                    const originalText = btnElement.innerText;
                    btnElement.innerText = "COPIED!";
                    btnElement.classList.add("bg-green-600", "text-white");
                    setTimeout(() => {
                        btnElement.innerText = originalText;
                        btnElement.classList.remove("bg-green-600", "text-white");
                    }, 2000);
                });
            }

            start() {
                const selector = document.getElementById('round-selector');
                this.currentRoundIndex = parseInt(selector.value);
                const selectedRound = this.rounds[this.currentRoundIndex];

                // 出題セットを作成（選択肢生成を含む）
                this.questions = selectedRound.words.map(target => {
                    // 正解以外の選択肢をマスターリスト全体から3つランダム取得
                    const distractors = this.getDistractors(target);
                    const options = [target.m, ...distractors].sort(() => Math.random() - 0.5);
                    return { w: target.w, m: target.m, o: options };
                });

                // 問題順をシャッフル
                this.questions.sort(() => Math.random() - 0.5);

                this.currentIndex = 0;
                this.missCount = 0;
                this.missedWordsLog = [];

                document.getElementById('circuit-name').innerText = selectedRound.name;
                document.getElementById('start-screen').classList.add('hidden');
                document.getElementById('champion-screen').classList.add('hidden');
                document.getElementById('result-screen').classList.add('hidden');
                document.getElementById('quiz-screen').classList.remove('hidden');

                this.startTime = Date.now();
                this.startTimer();
                this.showQuestion();
            }

            // 誤答選択肢の生成
            getDistractors(targetWord) {
                const distractors = [];
                while (distractors.length < 3) {
                    const randomIdx = Math.floor(Math.random() * this.masterList.length);
                    const randomWord = this.masterList[randomIdx];
                    
                    // 自分自身や、既に選んだものでなければ追加
                    if (randomWord.w !== targetWord.w && !distractors.includes(randomWord.m)) {
                        distractors.push(randomWord.m);
                    }
                }
                return distractors;
            }

            startTimer() {
                if (this.timerInterval) clearInterval(this.timerInterval);
                this.timerInterval = setInterval(() => {
                    const elapsed = (Date.now() - this.startTime) / 1000;
                    document.getElementById('timer').innerText = elapsed.toFixed(2) + 's';
                }, 50);
            }

            showQuestion() {
                const q = this.questions[this.currentIndex];
                document.getElementById('question-number').innerText = `LAP ${this.currentIndex + 1} / ${this.questions.length}`;
                document.getElementById('target-word').innerText = q.w;
                document.getElementById('progress-fill').style.width = `${(this.currentIndex / this.questions.length) * 100}%`;
                document.getElementById('feedback').innerText = '';

                const container = document.getElementById('options-container');
                container.innerHTML = '';

                q.o.forEach(option => {
                    const btn = document.createElement('button');
                    btn.className = 'option-btn w-full text-left p-6 rounded bg-white/5 border border-white/10 hover:border-red-500 font-bold text-lg md:text-xl shadow-lg';
                    btn.innerText = option;
                    btn.onclick = () => this.handleAnswer(option, q);
                    container.appendChild(btn);
                });
            }

            handleAnswer(selected, questionObj) {
                const feedback = document.getElementById('feedback');
                
                if (selected === questionObj.m) {
                    this.currentIndex++;
                    if (this.currentIndex < this.questions.length) {
                        this.showQuestion();
                    } else {
                        this.finish();
                    }
                } else {
                    this.missCount++;
                    feedback.innerText = `WRONG: ${questionObj.w} = ${questionObj.m}`;
                    feedback.className = "mt-4 text-center h-6 font-bold text-red-500 animate-pulse";
                    
                    if (!this.missedWordsLog.find(item => item.w === questionObj.w)) {
                        this.missedWordsLog.push({ w: questionObj.w, m: questionObj.m });
                    }
                    this.questions.push(questionObj);
                    
                    const btns = document.querySelectorAll('.option-btn');
                    btns.forEach(b => b.disabled = true);
                    
                    setTimeout(() => {
                        this.currentIndex++;
                        this.showQuestion();
                    }, 1200);
                }
            }

            finish() {
                clearInterval(this.timerInterval);
                document.getElementById('quiz-screen').classList.add('hidden');
                document.getElementById('result-screen').classList.remove('hidden');

                const totalTime = (Date.now() - this.startTime) / 1000;
                const roundLen = this.rounds[this.currentRoundIndex].words.length;
                const accuracy = (roundLen / (roundLen + this.missCount)) * 100;
                
                const accDisplay = document.getElementById('accuracy-display');
                accDisplay.innerText = `${accuracy.toFixed(1)}%`;
                
                const passArea = document.getElementById('pass-issue-area');
                const failMsg = document.getElementById('fail-message');

                if (accuracy >= 90) {
                    accDisplay.style.color = "#4ade80"; // Green
                    passArea.classList.remove('hidden');
                    failMsg.classList.add('hidden');
                    
                    const passId = "embarrass" ;
                    localStorage.setItem('PASS', passId);

                    const copyBtn = document.getElementById('copy-pass-btn');
                    copyBtn.onclick = () => this.copyToClipboard(passId, copyBtn);
                } else {
                    accDisplay.style.color = "#ef4444"; // Red
                    passArea.classList.add('hidden');
                    failMsg.classList.remove('hidden');
                }

                document.getElementById('rank-text').innerText = `Time: ${totalTime.toFixed(2)}s | Misses: ${this.missCount}`;

                const review = document.getElementById('review-list');
                let summaryHtml = `<div class="mb-4 font-bold text-white uppercase text-sm tracking-widest border-b border-gray-700 pb-2">Technical Telemetry</div>`;
                if (this.missedWordsLog.length > 0) {
                    summaryHtml += '<h3 class="text-red-500 mb-2 font-bold uppercase text-xs">Mechanical Failures (Review Needed):</h3>' + 
                        this.missedWordsLog.map(item => `<div class="mb-2 text-sm p-2 bg-red-900/10 border border-red-900/30 rounded"><span class="font-bold text-white block">${item.w}</span><span class="text-gray-400">${item.m}</span></div>`).join('');
                } else {
                    summaryHtml += '<p class="text-green-500 font-bold">Perfect Lap. No Issues Detected.</p>';
                }
                review.innerHTML = summaryHtml;
            }

            returnToGrid() {
                document.getElementById('result-screen').classList.add('hidden');
                document.getElementById('champion-screen').classList.add('hidden');
                document.getElementById('start-screen').classList.remove('hidden');
            }

            revokePass() {
                localStorage.removeItem('PASS');
                location.reload();
            }
        }

        const quiz = new VocabularyQuiz();
    </script>
</body>

</html>

